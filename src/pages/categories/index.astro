---
import BaseLayout from "../../layouts/app.layout.astro";
import { db, Category } from "astro:db";

const categories = await db.select().from(Category).orderBy(Category.name);
---

<BaseLayout title="Categories">
	<div
		class="shadow-md rounded-lg overflow-hidden transition-shadow hover:shadow-lg p-6"
	>
		<div class="flex justify-between items-center mb-6">
			<h1 class="text-2xl font-bold">Categorías</h1>
			<a
				href="/categories/create"
				class="bg-purple-700 text-white px-4 py-2 rounded-lg hover:bg-purple-600"
			>
				Agregar Categoría
			</a>
		</div>

		<div
			class="flex
			justify-between
			items-center
			mb-6
			p-6
			rounded-md
			shadow-purple-700/25
			bg-secondary-700/25
			text-white
			dark:bg-gray-800/25"
		>
			<table
				class="min-w-full divide-y divide-gray-200"
				id="default-table"
			>
				<thead class="bg-primary-100 text-white">
					<tr>
						<th scope="col">
							<span
								class="px-4
								py-2
								flex
								items-center
								font-medium
								uppercase
								tracking-wider
								text-primary-200
								dark:text-gray-100"
							>
								Nombre
								<svg
									class="w-4 h-4 ms-1"
									aria-hidden="true"
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									fill="none"
									viewBox="0 0 24 24"
								>
									<path
										stroke="currentColor"
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="m8 15 4 4 4-4m0-6-4-4-4 4"></path>
								</svg>
							</span></th
						>
						<th scope="col">
							<span
								class="px-4 py-2 flex items-center font-medium uppercase tracking-wider
								text-primary-200
								dark:text-gray-100"
							>
								Slug
								<svg
									class="w-4 h-4 ms-1"
									aria-hidden="true"
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									fill="none"
									viewBox="0 0 24 24"
								>
									<path
										stroke="currentColor"
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="m8 15 4 4 4-4m0-6-4-4-4 4"></path>
								</svg>
							</span></th
						>
						<th scope="col">
							<span
								class="px-4 py-2 flex items-center font-medium uppercase tracking-wider
								text-primary-200
								dark:text-gray-100"
								>Creado<svg
									class="w-4 h-4 ms-1"
									aria-hidden="true"
									xmlns="http://www.w3.org/2000/svg"
									width="24"
									height="24"
									fill="none"
									viewBox="0 0 24 24"
								>
									<path
										stroke="currentColor"
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="m8 15 4 4 4-4m0-6-4-4-4 4"></path>
								</svg>
							</span></th
						>
						<th
							scope="col"
							class="relative py-2 px-4 text-center text-xs font-medium uppercase tracking-wider
								text-primary-200
								dark:text-gray-100"
							><span class="sr-only">Actions</span></th
						>
					</tr>
				</thead>
				<tbody class="divide-y divide-slate-300 dark:divide-gray-400">
					{
						categories.map((category) => (
							<tr>
								<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
									{category.name}
								</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
									{category.slug}
								</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
									{new Date(
										category.created_at,
									).toLocaleDateString()}
								</td>
								<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
									<div
										class="inline-flex rounded-md shadow-sm"
										role="group"
									>
										<a
											href={`/categories/${category.id}/edit`}
											aria-current="page"
											class="
										px-1 
										py-1
										mr-1
										text-sm 
										font-medium 
										rounded-s-lg 
										focus:z-10 
										focus:ring-2 
										text-warning-500 
										hover:bg-warning-900 
										focus:ring-orange-500 
										focus:text-warning-500"
										>
											<span class="sr-only">Edit</span>
											<svg
												xmlns="http://www.w3.org/2000/svg"
												class="w-6 h-6"
												aria-hidden="true"
												fill="currentColor"
												viewBox="0 -960 960 960"
											>
												<path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h357l-80 80H200v560h560v-278l80-80v358q0 33-23.5 56.5T760-120H200Zm280-360ZM360-360v-170l367-367q12-12 27-18t30-6q16 0 30.5 6t26.5 18l56 57q11 12 17 26.5t6 29.5q0 15-5.5 29.5T897-728L530-360H360Zm481-424-56-56 56 56ZM440-440h56l232-232-28-28-29-28-231 231v57Zm260-260-29-28 29 28 28 28-28-28Z" />
											</svg>
										</a>
										<a
											href={`/categories/${category.id}/details`}
											aria-current="page"
											class="
										px-1 
										py-1
										mr-1
										text-sm 
										font-medium 
										rounded-md 
										focus:z-10 
										focus:ring-2 
										text-success-500 
										hover:bg-success-900 
										focus:ring-success-500 
										focus:text-success-500"
										>
											<span class="sr-only">Details</span>
											<svg
												class="w-6 h-6"
												aria-hidden="true"
												xmlns="http://www.w3.org/2000/svg"
												width="24"
												height="24"
												fill="none"
												viewBox="0 0 24 24"
											>
												<path
													stroke="currentColor"
													stroke-width="2"
													d="M21 12c0 1.2-4.03 6-9 6s-9-4.8-9-6c0-1.2 4.03-6 9-6s9 4.8 9 6Z"
												/>
												<path
													stroke="currentColor"
													stroke-width="2"
													d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
												/>
											</svg>
										</a>
										<button
											data-id={category.id}
											type="button"
											class="
											px-1 
											py-1 
											text-sm 
											font-medium 
											rounded-e-lg 
											focus:z-10 
											focus:ring-2  
											text-danger-400 
											hover:bg-danger-900 
											focus:ring-orange-600 
											focus:text-danger-500 
											delete-btn"
										>
											<span class="sr-only">Delete</span>
											<svg
												class="w-6 h-6"
												aria-hidden="true"
												xmlns="http://www.w3.org/2000/svg"
												fill="none"
												viewBox="0 0 24 24"
											>
												<path
													stroke="currentColor"
													stroke-linecap="round"
													stroke-linejoin="round"
													stroke-width="2"
													d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
												/>
											</svg>
										</button>
									</div>
								</td>
							</tr>
						))
					}
				</tbody>
			</table>
		</div>
	</div>

	<script>
		import { DataTable } from "simple-datatables";

		if (
			document.getElementById("default-table") &&
			typeof DataTable !== "undefined"
		) {
			const dataTable = new DataTable("#default-table", {
				searchable: true,
				sortable: true,
				perPage: 15,
				perPageSelect: [10, 15, 20, 50, 100],
				scrollY: "45vh",
			});
		}

		const deleteButtons = document.querySelectorAll(".delete-btn");
		deleteButtons.forEach((button) => {
			button.addEventListener("click", async () => {
				if (confirm("Are you sure you want to delete this category?")) {
					const id = button.getAttribute("data-id");
					try {
						const response = await fetch(`/api/categories/${id}`, {
							method: "DELETE",
						});
						if (response.ok) {
							window.location.reload();
						}
					} catch (error) {
						console.error("Error:", error);
					}
				}
			});
		});
	</script>
</BaseLayout>
